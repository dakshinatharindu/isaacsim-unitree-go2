Bootstrap: docker
From: ubuntu:22.04

%post
    # Set environment variables to avoid interactive prompts
    export DEBIAN_FRONTEND=noninteractive
    export TZ=UTC
    
    # Update package lists
    apt-get update
    
    # Install basic utilities
    apt-get install -y \
        curl \
        gnupg2 \
        lsb-release \
        software-properties-common \
        wget \
        sudo \
        locales \
        tzdata
    
    # Set up locale
    locale-gen en_US.UTF-8
    
    # Add ROS2 apt repository
    curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" | tee /etc/apt/sources.list.d/ros2.list > /dev/null
    
    # Update package lists again
    apt-get update
    
    # Install ROS2 Humble desktop
    apt-get install -y ros-humble-desktop
    
    # Install additional ROS2 tools
    apt-get install -y \
        python3-rosdep \
        python3-rosinstall \
        python3-rosinstall-generator \
        python3-wstool \
        build-essential \
        python3-colcon-common-extensions \
        python3-pip
    
    # Initialize rosdep
    rosdep init || true
    
    # Install Miniconda
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /tmp/miniconda.sh
    bash /tmp/miniconda.sh -b -p /opt/miniconda3
    rm /tmp/miniconda.sh
    
    # Make conda available to all users
    ln -s /opt/miniconda3/etc/profile.d/conda.sh /etc/profile.d/conda.sh
    echo '. /opt/miniconda3/etc/profile.d/conda.sh' >> /etc/bash.bashrc
    echo 'conda activate base' >> /etc/bash.bashrc
    
    # Clean up
    apt-get clean
    rm -rf /var/lib/apt/lists/*

%environment
    # Set locale
    export LANG=en_US.UTF-8
    export LC_ALL=en_US.UTF-8
    
    # Add conda to PATH
    export PATH="/opt/miniconda3/bin:$PATH"
    
    # Source ROS2 setup
    export ROS_DISTRO=humble
    . /opt/ros/humble/setup.sh

%runscript
    # Default behavior when container is run
    exec /bin/bash "$@"

%startscript
    # Commands to run when container starts as an instance
    echo "ROS2 Humble container started"

%help
    This container provides:
    - Ubuntu 22.04 base
    - ROS2 Humble desktop installation
    - User 'rosuser' with passwordless sudo access
    - Pre-configured ROS2 environment
    
    To use:
    apptainer shell ros2_humble.sif
    
    Then switch to the rosuser:
    su - rosuser
    
    Or run directly as rosuser:
    apptainer exec --fakeroot ros2_humble.sif su - rosuser