Bootstrap: docker
From: nvcr.io/nvidia/isaac-sim:4.5.0

%post
    # Set environment variables to avoid interactive prompts
    export DEBIAN_FRONTEND=noninteractive
    export TZ=UTC
    
    # Update package lists
    apt-get update
    
    # Install basic utilities
    apt-get install -y \
        curl \
        gnupg2 \
        lsb-release \
        software-properties-common \
        wget \
        sudo \
        locales \
        tzdata
    
    # Set up locale
    locale-gen en_US en_US.UTF-8
    update-locale LC_ALL=en_US.UTF-8 LANG=en_US.UTF-8
    export LANG=en_US.UTF-8

    # ROS2 Humble setup
    apt install software-properties-common -y
    add-apt-repository universe
    apt update && apt install curl -y
    
    export ROS_APT_SOURCE_VERSION=$(curl -s https://api.github.com/repos/ros-infrastructure/ros-apt-source/releases/latest | grep -F "tag_name" | awk -F\" '{print $4}')
    curl -L -o /tmp/ros2-apt-source.deb "https://github.com/ros-infrastructure/ros-apt-source/releases/download/${ROS_APT_SOURCE_VERSION}/ros2-apt-source_${ROS_APT_SOURCE_VERSION}.$(. /etc/os-release && echo $VERSION_CODENAME)_all.deb"
    dpkg -i /tmp/ros2-apt-source.deb
    rm /tmp/ros2-apt-source.deb
    apt update
    
    # Then proceed with ROS2 installation
    apt-get install -y ros-humble-ros-base
    
    # Install additional ROS2 tools
    apt-get install -y \
        python3-rosdep \
        python3-rosinstall \
        python3-rosinstall-generator \
        python3-wstool \
        build-essential \
        python3-colcon-common-extensions \
        python3-pip
    
    # Initialize rosdep
    rosdep init || true

    # Anaconda installation
    wget -q --show-progress --progress=bar:force:noscroll \
    https://repo.anaconda.com/archive/Anaconda3-2024.10-1-Linux-x86_64.sh \
    -O /tmp/Anaconda3-2024.10-1-Linux-x86_64.sh

    bash /tmp/Anaconda3-2024.10-1-Linux-x86_64.sh -b

    rm /tmp/Anaconda3-2024.10-1-Linux-x86_64.sh

    /root/anaconda3/bin/conda init && /root/anaconda3/bin/conda config --set auto_activate_base false
    
    # Create IsaacLab conda environment and install PyTorch
    # conda create -n env_isaaclab python=3.10 -y
    # conda activate env_isaaclab
    # pip install torch==2.7.0 torchvision==0.22.0 --index-url https://download.pytorch.org/whl/cu128
    # pip install --upgrade pip
    # pip install 'isaacsim[all,extscache]==4.5.0' --extra-index-url https://pypi.nvidia.com
    
    # Clean up
    # apt-get clean
    # rm -rf /var/lib/apt/lists/*

%environment
    # Set locale
    export LANG=en_US.UTF-8
    export LC_ALL=en_US.UTF-8
    
    # Add conda to PATH
    export PATH="/root/anaconda3/bin:$PATH"
    
    # Source ROS2 setup
    export ROS_DISTRO=humble
    . /opt/ros/humble/setup.sh

    # Source conda
    . ~/.bashrc

%runscript
    # Default behavior when container is run
    exec /bin/bash "$@"

%startscript
    # Commands to run when container starts as an instance
    echo "ROS2 Humble container started"

%help
    This container provides:
    - Ubuntu 22.04 base
    - ROS2 Humble desktop installation
    - User 'rosuser' with passwordless sudo access
    - Pre-configured ROS2 environment
    
    To use:
    apptainer shell ros2_humble.sif
    
    Then switch to the rosuser:
    su - rosuser
    
    Or run directly as rosuser:
    apptainer exec --fakeroot ros2_humble.sif su - rosuser